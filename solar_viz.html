<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Solar Radiation Visualization - D3.js</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 20px;
        min-height: 100vh;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        padding: 40px;
      }

      h1 {
        text-align: center;
        color: #2c3e50;
        margin-bottom: 10px;
        font-size: 2.5em;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      .subtitle {
        text-align: center;
        color: #7f8c8d;
        margin-bottom: 40px;
        font-size: 1.1em;
      }

      .chart-container {
        margin: 40px 0;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .chart-title {
        font-size: 1.5em;
        color: #2c3e50;
        margin-bottom: 20px;
        text-align: center;
        font-weight: 600;
      }

      .axis {
        font-size: 12px;
      }

      .axis-label {
        font-size: 14px;
        font-weight: 600;
      }

      .line {
        fill: none;
        stroke-width: 3;
      }

      .dot {
        cursor: pointer;
        transition: all 0.3s;
      }

      .dot:hover {
        r: 8;
        stroke-width: 3;
      }

      .grid line {
        stroke: lightgrey;
        stroke-opacity: 0.7;
        stroke-dasharray: 3, 3;
      }

      .grid path {
        stroke-width: 0;
      }

      .tooltip {
        position: absolute;
        background: rgba(0, 0, 0, 0.9);
        color: white;
        padding: 12px 16px;
        border-radius: 8px;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.3s;
        font-size: 14px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
      }

      .legend {
        font-size: 14px;
        cursor: pointer;
      }

      .legend-item:hover rect {
        stroke: #000;
        stroke-width: 2;
      }

      .stats-box {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin: 30px 0;
      }

      .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s;
      }

      .stat-card:hover {
        transform: translateY(-5px);
      }

      .stat-label {
        font-size: 0.9em;
        opacity: 0.9;
        margin-bottom: 5px;
      }

      .stat-value {
        font-size: 2em;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>☀️ Solar Radiation Analysis</h1>
      <p class="subtitle">Interactive D3.js Visualization Dashboard</p>

      <div class="stats-box" id="stats"></div>

      <div class="chart-container">
        <div class="chart-title">Monthly Radiation Components</div>
        <div id="chart1"></div>
      </div>

      <div class="chart-container">
        <div class="chart-title">Environmental Input Variables</div>
        <div id="chart2"></div>
      </div>

      <div class="chart-container">
        <div class="chart-title">Correlation Matrix Heatmap</div>
        <div id="chart3"></div>
      </div>
    </div>

    <div class="tooltip" id="tooltip"></div>

    <script>
      // Data
      const months = [
        "Jan",
        "Feb",
        "Mar",
        "Apr",
        "May",
        "Jun",
        "Jul",
        "Aug",
        "Sep",
        "Oct",
        "Nov",
        "Dec",
      ];

      const G0 = [
        575.23, 687.15, 814.34, 934.69, 1002.4, 1026.65, 1014.34, 959.27,
        852.72, 713.18, 595.15, 541.45,
      ];

      const h = [
        8.29, 8.47, 8.11, 6.95, 6.44, 4.23, 3.94, 5.13, 5.28, 7.8, 8.73, 8.36,
      ];

      const N = [
        9.82, 10.43, 11.13, 11.88, 12.46, 12.73, 12.58, 12.07, 11.35, 10.6,
        9.93, 9.62,
      ];

      const W = [
        10.96, 11.3, 14.2, 17.33, 19.47, 22.08, 22.48, 22.7, 22.1, 19.95, 15.6,
        12.39,
      ];

      const R = [
        70.67, 69.1, 66.1, 75.11, 81.7, 86.7, 87.5, 85.5, 86.22, 82.3, 75.3,
        73.9,
      ];

      // Calculate derived values
      const G = G0.map(
        (g0, i) => g0 * (0.394 + 0.364 * (h[i] / N[i] ** 2) * 0.0035 * W[i])
      );
      const D = G0.map(
        (g0, i) => g0 * (0.306 - 0.165 * (h[i] / N[i] ** 2) + 0.0025 * W[i])
      );
      const B = G.map((g, i) => g - D[i]);

      // Create stats
      const stats = [
        {
          label: "Max Total Radiation",
          value: d3.max(G).toFixed(2),
          unit: "W/m²",
        },
        { label: "Avg Humidity", value: d3.mean(R).toFixed(1), unit: "%" },
        {
          label: "Max Sunshine Hours",
          value: d3.max(h).toFixed(2),
          unit: "hrs",
        },
        {
          label: "Annual G0 Sum",
          value: (d3.sum(G0) / 12).toFixed(2),
          unit: "W/m²",
        },
      ];

      d3.select("#stats")
        .selectAll(".stat-card")
        .data(stats)
        .enter()
        .append("div")
        .attr("class", "stat-card")
        .html(
          (d) => `
                <div class="stat-label">${d.label}</div>
                <div class="stat-value">${d.value}</div>
                <div class="stat-label">${d.unit}</div>
            `
        );

      // Chart 1: Radiation components
      function createLineChart(containerId, datasets, title) {
        const margin = { top: 20, right: 120, bottom: 50, left: 60 };
        const width = 900 - margin.left - margin.right;
        const height = 400 - margin.top - margin.bottom;

        const svg = d3
          .select(containerId)
          .append("svg")
          .attr("width", width + margin.left + margin.right)
          .attr("height", height + margin.top + margin.bottom)
          .append("g")
          .attr("transform", `translate(${margin.left},${margin.top})`);

        const x = d3.scaleBand().domain(months).range([0, width]).padding(0.1);

        const allValues = datasets.flatMap((d) => d.values);
        const y = d3
          .scaleLinear()
          .domain([0, d3.max(allValues) * 1.1])
          .range([height, 0]);

        // Grid
        svg
          .append("g")
          .attr("class", "grid")
          .call(d3.axisLeft(y).tickSize(-width).tickFormat(""));

        // Axes
        svg
          .append("g")
          .attr("transform", `translate(0,${height})`)
          .attr("class", "axis")
          .call(d3.axisBottom(x))
          .selectAll("text")
          .attr("transform", "rotate(-45)")
          .style("text-anchor", "end");

        svg.append("g").attr("class", "axis").call(d3.axisLeft(y));

        // Line generator
        const line = d3
          .line()
          .x((d, i) => x(months[i]) + x.bandwidth() / 2)
          .y((d) => y(d))
          .curve(d3.curveMonotoneX);

        // Tooltip
        const tooltip = d3.select("#tooltip");

        // Draw lines and points for each dataset
        datasets.forEach((dataset, idx) => {
          // Line
          svg
            .append("path")
            .datum(dataset.values)
            .attr("class", "line")
            .attr("d", line)
            .style("stroke", dataset.color);

          // Points
          svg
            .selectAll(`.dot-${idx}`)
            .data(dataset.values)
            .enter()
            .append("circle")
            .attr("class", "dot")
            .attr("cx", (d, i) => x(months[i]) + x.bandwidth() / 2)
            .attr("cy", (d) => y(d))
            .attr("r", 5)
            .style("fill", dataset.color)
            .style("stroke", "white")
            .style("stroke-width", 2)
            .on("mouseover", function (event, d) {
              const i = dataset.values.indexOf(d);
              tooltip
                .style("opacity", 1)
                .html(
                  `<strong>${months[i]}</strong><br>${
                    dataset.name
                  }: ${d.toFixed(2)}`
                )
                .style("left", event.pageX + 10 + "px")
                .style("top", event.pageY - 10 + "px");
            })
            .on("mouseout", function () {
              tooltip.style("opacity", 0);
            });
        });

        // Legend
        const legend = svg
          .selectAll(".legend")
          .data(datasets)
          .enter()
          .append("g")
          .attr("class", "legend legend-item")
          .attr("transform", (d, i) => `translate(${width + 10}, ${i * 25})`);

        legend
          .append("rect")
          .attr("width", 18)
          .attr("height", 18)
          .style("fill", (d) => d.color);

        legend
          .append("text")
          .attr("x", 24)
          .attr("y", 9)
          .attr("dy", ".35em")
          .text((d) => d.name);
      }

      // Create Chart 1
      createLineChart("#chart1", [
        { name: "Total Radiation (G)", values: G, color: "#E74C3C" },
        { name: "Diffuse (D)", values: D, color: "#27AE60" },
        { name: "Direct Beam (B)", values: B, color: "#3498DB" },
      ]);

      // Create Chart 2
      createLineChart("#chart2", [
        { name: "Relative Humidity (%)", values: R, color: "#3498DB" },
        { name: "Sunshine Hours (h)", values: h, color: "#E74C3C" },
        { name: "Max Duration (N)", values: N, color: "#F39C12" },
        { name: "Abs Humidity (W)", values: W, color: "#9B59B6" },
      ]);

      // Chart 3: Correlation Heatmap
      function createHeatmap() {
        const data = { G0, h, N, W, R, G, D, B };
        const variables = Object.keys(data);

        // Calculate correlation matrix
        const correlation = [];
        variables.forEach((var1, i) => {
          variables.forEach((var2, j) => {
            const corr = calculateCorrelation(data[var1], data[var2]);
            correlation.push({
              row: var1,
              col: var2,
              value: corr,
            });
          });
        });

        const margin = { top: 80, right: 25, bottom: 25, left: 80 };
        const cellSize = 70;
        const width = cellSize * variables.length;
        const height = cellSize * variables.length;

        const svg = d3
          .select("#chart3")
          .append("svg")
          .attr("width", width + margin.left + margin.right)
          .attr("height", height + margin.top + margin.bottom)
          .append("g")
          .attr("transform", `translate(${margin.left},${margin.top})`);

        const x = d3.scaleBand().domain(variables).range([0, width]);

        const y = d3.scaleBand().domain(variables).range([0, height]);

        const colorScale = d3
          .scaleSequential()
          .domain([-1, 1])
          .interpolator(d3.interpolateRdBu);

        const tooltip = d3.select("#tooltip");

        svg
          .selectAll()
          .data(correlation)
          .enter()
          .append("rect")
          .attr("x", (d) => x(d.col))
          .attr("y", (d) => y(d.row))
          .attr("width", x.bandwidth())
          .attr("height", y.bandwidth())
          .style("fill", (d) => colorScale(d.value))
          .style("stroke", "white")
          .style("stroke-width", 2)
          .on("mouseover", function (event, d) {
            tooltip
              .style("opacity", 1)
              .html(
                `<strong>${d.row} vs ${
                  d.col
                }</strong><br>Correlation: ${d.value.toFixed(3)}`
              )
              .style("left", event.pageX + 10 + "px")
              .style("top", event.pageY - 10 + "px");
          })
          .on("mouseout", () => tooltip.style("opacity", 0));

        // Add text labels
        svg
          .selectAll()
          .data(correlation)
          .enter()
          .append("text")
          .attr("x", (d) => x(d.col) + x.bandwidth() / 2)
          .attr("y", (d) => y(d.row) + y.bandwidth() / 2)
          .attr("text-anchor", "middle")
          .attr("dominant-baseline", "middle")
          .text((d) => d.value.toFixed(2))
          .style("font-size", "11px")
          .style("fill", (d) => (Math.abs(d.value) > 0.5 ? "white" : "black"))
          .style("font-weight", "600")
          .style("pointer-events", "none");

        // Axes
        svg
          .append("g")
          .call(d3.axisTop(x))
          .selectAll("text")
          .attr("transform", "rotate(-45)")
          .style("text-anchor", "start");

        svg.append("g").call(d3.axisLeft(y));
      }

      function calculateCorrelation(x, y) {
        const n = x.length;
        const meanX = d3.mean(x);
        const meanY = d3.mean(y);

        let numerator = 0;
        let denomX = 0;
        let denomY = 0;

        for (let i = 0; i < n; i++) {
          const dx = x[i] - meanX;
          const dy = y[i] - meanY;
          numerator += dx * dy;
          denomX += dx * dx;
          denomY += dy * dy;
        }

        return numerator / Math.sqrt(denomX * denomY);
      }

      createHeatmap();
    </script>
  </body>
</html>
